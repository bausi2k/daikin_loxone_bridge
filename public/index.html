<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0b0d11">
    <title>Daikin Bridge</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* CSS bleibt identisch wie vorher, nur ein Style für den Datepicker */
        :root {
            --bg-base: #0b0d11;
            --surface: rgba(31, 33, 41, 0.7);
            --surface-solid: #1f2129;
            --surface-variant: rgba(255, 255, 255, 0.05);
            --primary: #a8c7fa; --on-primary: #062e6f; --secondary: #e2e2e6; --text-dim: #9ca1aa;
            --success: #6dd58c; --heat: #ffb74d; --cool: #78d9f5;
            --heat-bg: linear-gradient(135deg, rgba(74, 45, 0, 0.8), rgba(60, 30, 0, 0.6));
            --cool-bg: linear-gradient(135deg, rgba(0, 51, 74, 0.8), rgba(0, 40, 60, 0.6));
            --error: #ffb4ab; --error-bg: #93000a;
            --radius: 28px; --font: 'Google Sans', 'Segoe UI', system-ui, sans-serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; color: var(--secondary); font-family: var(--font); display: flex; height: 100vh; overflow: hidden; background-color: var(--bg-base); background-image: radial-gradient(at 0% 0%, rgba(56, 73, 102, 0.4) 0px, transparent 50%), radial-gradient(at 100% 0%, rgba(30, 30, 40, 0.3) 0px, transparent 50%), linear-gradient(180deg, var(--bg-base) 0%, #000000 100%); background-attachment: fixed; background-size: cover; }
        .sidebar { width: 280px; background: rgba(15, 17, 22, 0.6); backdrop-filter: blur(20px); display: flex; flex-direction: column; padding: 30px 20px; border-right: 1px solid rgba(255,255,255,0.05); z-index: 10; }
        .mobile-header, .bottom-nav { display: none; }
        .brand { font-size: 1.5rem; font-weight: 500; margin-bottom: 50px; color: var(--secondary); display: flex; align-items: center; gap: 15px; padding-left: 10px; }
        .nav-btn { background: transparent; border: none; color: var(--text-dim); text-align: left; padding: 16px 24px; cursor: pointer; border-radius: 50px; margin-bottom: 8px; display: flex; align-items: center; gap: 16px; font-size: 1rem; font-weight: 500; transition: all 0.2s ease; }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: var(--secondary); }
        .nav-btn.active { background: rgba(168, 199, 250, 0.15); color: var(--primary); }
        .nav-icon { width: 24px; height: 24px; fill: currentColor; }
        .main { flex: 1; padding: 40px; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h2 { font-size: 1.75rem; font-weight: 400; margin: 0; color: #fff; }
        .view { display: none; animation: fadeUp 0.5s cubic-bezier(0.2, 0, 0, 1); }
        .view.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .tile-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 30px; }
        .tile { background: rgba(35, 38, 45, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); border-radius: var(--radius); padding: 20px; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; transition: all 0.3s ease; position: relative; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .tile:active { transform: scale(0.98); }
        .tile.active-heat { background: var(--heat-bg); border: 1px solid rgba(255, 183, 77, 0.3); }
        .tile.active-cool { background: var(--cool-bg); border: 1px solid rgba(120, 217, 245, 0.3); }
        .tile-icon { width: 28px; height: 28px; margin-bottom: 10px; fill: currentColor; }
        .tile-label { font-size: 0.9rem; font-weight: 500; opacity: 0.8; }
        .tile-value { font-size: 2rem; font-weight: 400; margin-top: 5px; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .card { background: linear-gradient(145deg, rgba(35, 38, 45, 0.8), rgba(25, 27, 32, 0.9)); border: 1px solid rgba(255,255,255,0.03); padding: 24px; border-radius: var(--radius); display: flex; flex-direction: column; gap: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .card-title { font-size: 1.2rem; font-weight: 500; color: #fff; }
        .temp-control { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); border-radius: 20px; padding: 10px 20px; }
        .temp-display { font-size: 2.5rem; font-weight: 400; color: #fff; }
        .temp-unit { font-size: 1rem; color: var(--text-dim); }
        .stepper { display: flex; gap: 10px; }
        .step-btn { width: 48px; height: 48px; border-radius: 50%; border: none; background: rgba(255,255,255,0.08); color: #fff; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .step-btn:hover { background: rgba(255,255,255,0.15); }
        .step-btn:active { background: var(--primary); color: var(--on-primary); }
        .mode-selector { display: flex; gap: 5px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 50px; }
        .mode-btn { flex: 1; border: none; background: transparent; color: var(--text-dim); padding: 12px; border-radius: 40px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .mode-btn.active-on { background: rgba(255,255,255,0.1); color: #fff; }
        .mode-btn.active-heat { background: var(--heat); color: #222; box-shadow: 0 0 15px rgba(255, 183, 77, 0.4); }
        .mode-btn.active-cool { background: var(--cool); color: #000; box-shadow: 0 0 15px rgba(120, 217, 245, 0.4); }
        .mode-btn.active-turbo { background: #ff2d55; color: white; box-shadow: 0 0 15px rgba(255, 45, 85, 0.4); }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        .log-console { background: rgba(0,0,0,0.3); border-radius: 16px; padding: 20px; height: 60vh; overflow-y: auto; font-family: 'Roboto Mono', monospace; font-size: 0.85rem; border: 1px solid rgba(255,255,255,0.05); }
        .log-entry { padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; gap: 10px; align-items: flex-start; }
        .log-time { color: #666; min-width: 130px; font-size: 0.8rem; }
        .log-msg { word-break: break-all; }
        .log-cat-system { color: var(--text-dim); } .log-cat-error { color: var(--error); } .log-cat-input { color: #81c784; } .log-cat-output { color: #ffcc80; }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; align-items: center; }
        .filter-pill { background: rgba(255,255,255,0.05); border: none; padding: 8px 16px; border-radius: 20px; color: var(--text-dim); cursor: pointer; font-size: 0.9rem; white-space: nowrap; transition: 0.2s; }
        .filter-pill.active { background: var(--primary); color: var(--on-primary); font-weight: 600; }
        
        /* DATE PICKER */
        .date-input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 8px 12px; border-radius: 12px; font-family: var(--font); margin-left: auto; width: auto; margin-top:0; }
        ::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

        input, select { width: 100%; padding: 16px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; font-family: var(--font); font-size: 1rem; margin-top: 8px; outline: none; transition: border 0.2s; }
        input:focus, select:focus { border-color: var(--primary); }
        .btn-primary { background: var(--primary); color: var(--on-primary); border: none; padding: 16px; border-radius: 50px; width: 100%; font-size: 1rem; font-weight: 600; margin-top: 20px; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 4px 15px rgba(168, 199, 250, 0.2); }
        .btn-download { background: rgba(255,255,255,0.05); color: var(--primary); box-shadow: none; border: 1px solid rgba(168, 199, 250, 0.3); display:flex; align-items:center; justify-content:center; gap:10px; font-size: 0.9rem;}
        .status-dot { width: 10px; height: 10px; background: #444; border-radius: 50%; display: inline-block; }
        .status-dot.connected { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .mqtt-badge { background: rgba(255,255,255,0.05); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,0.05); }
        .mqtt-dot { width: 6px; height: 6px; background: #666; border-radius: 50%; }
        .mqtt-dot.ok { background: var(--success); box-shadow: 0 0 5px var(--success); }
        #errorBanner { position: fixed; bottom: 100px; left: 20px; right: 20px; background: var(--error-bg); color: var(--error); padding: 15px; border-radius: 16px; text-align: center; font-weight: bold; display: none; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid var(--error); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        th { text-align: left; padding: 10px; color: var(--text-dim); border-bottom: 1px solid rgba(255,255,255,0.1); }
        td { padding: 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); vertical-align: top; }
        code { background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 6px; font-family: 'Roboto Mono', monospace; color: var(--primary); display: inline-block; margin-bottom: 4px; border: 1px solid rgba(255,255,255,0.05); }
        h3 { margin-top: 40px; margin-bottom: 10px; font-size: 1.3rem; color: #fff; }
        h4 { margin: 20px 0 10px 0; color: var(--primary); opacity: 0.8; }
        .refresh-icon { background: rgba(255,255,255,0.05); border-radius: 50%; padding: 10px; cursor: pointer; transition: transform 0.5s; display: flex; border: 1px solid rgba(255,255,255,0.05); }
        .refresh-icon svg { width: 24px; height: 24px; fill: var(--secondary); }
        .spin { transform: rotate(360deg); }

        @media (max-width: 768px) {
            .sidebar { display: none !important; width: 0; }
            body { display: block; position: relative; }
            .mobile-header { display: flex !important; justify-content: space-between; align-items: center; padding: 15px 20px; padding-top: max(15px, env(safe-area-inset-top)); background: rgba(11, 13, 17, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; border-bottom: 1px solid rgba(255,255,255,0.05); box-sizing: border-box; }
            .main { width: 100%; margin-left: 0; padding: 20px; padding-top: 90px; padding-bottom: 100px; height: auto; overflow: visible; box-sizing: border-box; }
            .desktop-only-header { display: none !important; }
            .bottom-nav { display: flex !important; position: fixed; bottom: 20px; left: 20px; right: 20px; background: rgba(30, 32, 38, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.08); border-radius: 50px; height: 70px; justify-content: space-around; align-items: center; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.4); padding-bottom: 0; }
            #mqttBadgeMobile { padding: 0; background: none; border: none; } #mqttBadgeMobile span { display: none; } #mqttBadgeMobile .mqtt-dot { width: 10px; height: 10px; }
            .b-nav-item { background: none; border: none; color: var(--text-dim); display: flex; flex-direction: column; align-items: center; gap: 4px; }
            .b-nav-item.active { color: var(--primary); }
            .b-nav-item.active svg { fill: var(--primary); filter: drop-shadow(0 0 5px rgba(168, 199, 250, 0.4)); }
            .b-nav-item svg { width: 24px; height: 24px; fill: #666; transition: all 0.2s; }
            .b-nav-item span { font-size: 0.7rem; font-weight: 500; }
        }
    </style>
</head>
<body>

<div class="mobile-header">
    <div style="font-weight:500; font-size:1.2rem; display:flex; align-items:center; gap:10px; color:white;"><span class="status-dot" id="connDotMobile"></span> Daikin Bridge</div>
    <div style="display:flex; gap:15px; align-items:center;">
        <div id="mqttBadgeMobile" class="mqtt-badge"><span class="mqtt-dot" id="mqttDotMobile"></span> <span>MQTT</span></div>
        <div class="refresh-icon" onclick="manualRefresh()"><svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></div>
    </div>
</div>

<div class="sidebar">
    <div class="brand"><span class="status-dot" id="connDot"></span> Daikin Bridge</div>
    <button class="nav-btn active" onclick="switchTab('dashboard')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg> Home</button>
    <button class="nav-btn" onclick="switchTab('charts')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg> Analytics</button>
    <button class="nav-btn" onclick="switchTab('logs')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 14H7v-2h10v2zm0-4H7V7h10v2z"/></svg> Logs</button>
    <button class="nav-btn" onclick="switchTab('config')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.57 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5-3.5-1.57 3.5-3.5 3.5z"/></svg> Setup</button>
</div>

<div class="main">
    <div id="errorBanner">⚠️ STÖRUNG ⚠️</div>

    <div id="view-dashboard" class="view active">
        <div class="header-area desktop-only-header">
            <h2>Übersicht</h2>
            <div style="display:flex; gap:15px; align-items:center;">
                <div id="mqttBadge" class="mqtt-badge"><span class="mqtt-dot" id="mqttDot"></span> MQTT</div>
                <div class="refresh-icon" onclick="manualRefresh()"><svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></div>
            </div>
        </div>
        
        <div class="tile-grid">
            <div class="tile" id="tile-vlt"><svg class="tile-icon" viewBox="0 0 24 24"><path d="M12 2L2 12h3v8h6v-6h2v6h6v-8h3L12 2zm0 2.84L19.16 12H17v8h-4v-6h-2v6H7v-8H4.84L12 4.84z"/></svg><div><div class="tile-label">Vorlauf Ist</div><div class="tile-value"><span id="val-vlt">--</span>°</div></div></div>
            <div class="tile" id="tile-tank"><svg class="tile-icon" viewBox="0 0 24 24"><path d="M12 2C7.58 2 4 4.2 4 7v10c0 2.8 3.58 5 8 5s8-2.2 8-5V7c0-2.8-3.58-5-8-5zm0 2c3.27 0 6 1.25 6 3 0 1.75-2.73 3-6 3s-6-1.25-6-3c0-1.75 2.73-3 6-3zm0 16c-3.27 0-6-1.25-6-3V8.8c1.23.97 3.45 1.7 6 1.7s4.77-.73 6-1.7V17c0 1.75-2.73 3-6 3z"/></svg><div><div class="tile-label">Warmwasser</div><div class="tile-value"><span id="val-tank">--</span>°</div></div></div>
            <div class="tile"><svg class="tile-icon" viewBox="0 0 24 24"><path d="M12 3L2 12h3v8h14v-8h3L12 3zm0 5.5c1.38 0 2.5 1.12 2.5 2.5S13.38 13.5 12 13.5s-2.5-1.12-2.5-2.5S10.62 8.5 12 8.5z"/></svg><div><div class="tile-label">Innen</div><div class="tile-value"><span id="val-indoor">--</span>°</div></div></div>
            <div class="tile"><svg class="tile-icon" viewBox="0 0 24 24"><path d="M12 2c-5.52 0-10 4.48-10 10s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg><div><div class="tile-label">Außen</div><div class="tile-value"><span id="val-outdoor">--</span>°</div></div></div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-header"><span class="card-title">Heizkreis</span><div id="badge-mode" style="font-size:0.8rem; font-weight:bold; color:var(--text-dim);">STANDBY</div></div>
                <div class="temp-control"><div><div style="font-size:0.8rem; opacity:0.7;">Sollwert</div><div><span class="temp-display" id="val-vlt-target">--</span> <span class="temp-unit">°C</span></div></div><div><div style="font-size:0.8rem; opacity:0.7; text-align:right;">Offset</div><div class="stepper" style="margin-top:5px;"><button class="step-btn" onclick="changeOffset(-1)">-</button><div style="display:flex; align-items:center; font-weight:bold; width:40px; justify-content:center;"><span id="val-offset">0</span></div><button class="step-btn" onclick="changeOffset(1)">+</button></div></div></div>
                <div class="mode-selector">
                    <button class="mode-btn" id="btn-heat-off" onclick="sendCmd('power', 'standby')">Aus</button>
                    <button class="mode-btn" id="btn-mode-heat" onclick="setMode('heating')">Heizen</button>
                    <button class="mode-btn" id="btn-mode-cool" onclick="setMode('cooling')">Kühlen</button>
                    <button class="mode-btn" id="btn-mode-auto" onclick="setMode('auto')">Auto</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">Warmwasser</span></div>
                <div class="temp-control"><div><div style="font-size:0.8rem; opacity:0.7;">Sollwert</div><div><span class="temp-display" id="val-ww-target">--</span> <span class="temp-unit">°C</span></div></div></div>
                <div class="mode-selector">
                    <button class="mode-btn" id="btn-ww-off" onclick="sendCmd('ww_power', 'standby')">Aus</button>
                    <button class="mode-btn" id="btn-ww-on" onclick="sendCmd('ww_power', 'on')">An</button>
                    <button class="mode-btn" id="btn-turbo" onclick="toggleTurbo()">Turbo</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-charts" class="view">
        <div class="header-area"><h2>Analytics</h2><div class="refresh-icon" onclick="loadHistory()"><svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></div></div>
        <select id="chartFilter" onchange="loadHistory()" style="margin-bottom:20px;"><option value="24h">Letzte 24 Stunden</option><option value="today">Heute</option><option value="compare_days">Heute vs. Gestern</option><option disabled>──────────</option><option value="month">Aktueller Monat</option><option value="last_month">Letzter Monat</option><option value="compare_months">Dieser vs. Letzter Monat</option></select>
        <div class="card" style="margin-bottom:20px"><div class="card-title">Vorlauf Analyse</div><div class="chart-wrapper"><canvas id="vltChart"></canvas></div></div>
        <div class="card" style="margin-bottom:20px"><div class="card-title">Warmwasser</div><div class="chart-wrapper"><canvas id="tankChart"></canvas></div></div>
        <div class="card" style="margin-bottom:20px"><div class="card-title">Innen Temperatur</div><div class="chart-wrapper"><canvas id="indoorChart"></canvas></div></div>
        <div class="card" style="margin-bottom:20px"><div class="card-title">Außen Temperatur</div><div class="chart-wrapper"><canvas id="outdoorChart"></canvas></div></div>
    </div>

    <div id="view-logs" class="view">
        <div class="header-area"><h2>System Logs</h2><div style="cursor:pointer; color:var(--primary)" onclick="document.getElementById('log-container').innerHTML=''">Clear</div></div>
        <div class="filter-bar">
            <button class="filter-pill active" onclick="filterLogs('all', this)">Alle</button>
            <button class="filter-pill" onclick="filterLogs('system', this)">System</button>
            <button class="filter-pill" onclick="filterLogs('input', this)">Daten (In)</button>
            <button class="filter-pill" onclick="filterLogs('output', this)">Befehle (Out)</button>
            <input type="date" id="logDate" class="date-input" onchange="fetchLogs()">
        </div>
        <div id="log-container" class="log-console"></div>
    </div>

    <div id="view-config" class="view">
        <div class="header-area"><h2>Einstellungen</h2></div>
        <div class="grid">
            <div class="card">
                <div class="card-title">Verbindungen</div>
                <label>Daikin IP</label><input type="text" id="cfg-daikin">
                <label>Loxone IP</label><input type="text" id="cfg-loxone">
                <label>Loxone Port (UDP)</label><input type="number" id="cfg-port">
                <label>Loxone UDP Keep-Alive (Sek)</label><input type="number" id="cfg-keepAlive" placeholder="90">
            </div>
            <div class="card">
                <div class="card-title">MQTT</div>
                <label>Broker</label><input type="text" id="cfg-mqttBroker">
                <label>Topic</label><input type="text" id="cfg-mqttTopic">
                <label>User</label><input type="text" id="cfg-mqttUser">
                <label>Pass</label><input type="password" id="cfg-mqttPass">
            </div>
        </div>
        <button class="btn-primary" onclick="saveConfig()">Speichern & Neustart</button>
        <div class="card" style="margin-top:20px;"><div class="card-title" style="margin-bottom:10px">Loxone Integration</div><div style="display:flex; gap:10px; flex-wrap:wrap;"><a href="/api/loxone.xml" target="_blank" style="text-decoration:none; flex:1;"><button class="btn-primary btn-download">Eingänge (UDP)</button></a><a href="/api/loxone_out.xml" target="_blank" style="text-decoration:none; flex:1;"><button class="btn-primary btn-download">Ausgänge (HTTP)</button></a></div></div>
        <h3>API Dokumentation</h3>
        <div class="card">
            <h4>1. HTTP Steuerung (Ausgang)</h4>
            <p style="font-size:0.8rem; color:#888;">Nutze <code>&lt;v&gt;</code> als Platzhalter in Loxone.</p>
            <table>
                <tr><th>Funktion</th><th>Befehl / URI</th><th>Erlaubte Werte</th></tr>
                <tr><td>Heizung Ein/Aus</td><td><code>/set?cmd=power&val=&lt;v&gt;</code></td><td>0=Aus, 1=Ein</td></tr>
                <tr><td>Modus</td><td><code>/set?cmd=mode&val=&lt;v&gt;</code></td><td>0=Standby, 1=Heiz, 2=Kühl, 3=Auto</td></tr>
                <tr><td>VLT Soll</td><td><code>/set?cmd=vlt&val=&lt;v&gt;</code></td><td>Temperatur (z.B. 35)</td></tr>
                <tr><td>Offset</td><td><code>/set?cmd=offset_heat&val=&lt;v&gt;</code></td><td>-5 bis +5</td></tr>
                <tr><td>WW Ein/Aus</td><td><code>/set?cmd=ww_power&val=&lt;v&gt;</code></td><td>0=Aus, 1=Ein</td></tr>
                <tr><td>WW Turbo</td><td><code>/set?cmd=ww_powerful&val=&lt;v&gt;</code></td><td>0=Aus, 1=Ein</td></tr>
                <tr><td>WW Soll</td><td><code>/set?cmd=ww_temp&val=&lt;v&gt;</code></td><td>Temperatur (z.B. 48)</td></tr>
            </table>
            
            <h4>2. UDP Empfang (Eingang)</h4>
            <table>
                <tr><th>Kategorie</th><th>Erkennung</th><th>Wertebereich</th></tr>
                <tr><td>Status</td><td><code>WP_Mode: \v</code><br><code>WP_Power_Heating: \v</code><br><code>WP_Power_WW: \v</code><br><code>WP_Powerful_WW: \v</code></td><td>0=Aus, 1=Heiz, 2=Kühl, 3=Auto<br>0=Aus, 1=Ein<br>0=Aus, 1=Ein<br>0=Aus, 1=Ein</td></tr>
                <tr><td>Temperaturen (Ist)</td><td><code>WP_VLT: \v</code><br><code>WP_OutdoorTemp: \v</code><br><code>WP_IndoorTemp: \v</code><br><code>WP_TankTemp: \v</code></td><td>Gleitkommazahl (°C)</td></tr>
                <tr><td>Temperaturen (Soll)</td><td><code>WP_TargetVLT_Heat: \v</code><br><code>WP_TargetVLT_Cool: \v</code><br><code>WP_TargetTemp_WW: \v</code></td><td>Gleitkommazahl (°C)</td></tr>
                <tr><td>Offsets</td><td><code>WP_Offset_Heat: \v</code><br><code>WP_Offset_Cool: \v</code></td><td>Gleitkommazahl (K)</td></tr>
                <tr><td>Fehler</td><td><code>WP_Error: \v</code></td><td>Fehlercode (0=OK)</td></tr>
            </table>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <button class="b-nav-item active" onclick="switchTab('dashboard')"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>Home</span></button>
    <button class="b-nav-item" onclick="switchTab('charts')"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg><span>Analytics</span></button>
    <button class="b-nav-item" onclick="switchTab('logs')"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg><span>Logs</span></button>
    <button class="b-nav-item" onclick="switchTab('config')"><svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg><span>Setup</span></button>
</div>

<script>
    let currentState = {};
    const logContainer = document.getElementById('log-container');
    let chartVLT = null, chartTank = null, chartIndoor = null, chartOutdoor = null;
    let currentFilter = 'all';
    
    // Init: Setze Datepicker auf heute
    document.getElementById('logDate').valueAsDate = new Date();

    function switchTab(name) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + name).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.b-nav-item').forEach(el => el.classList.remove('active'));
        const idx = name === 'dashboard' ? 0 : name === 'charts' ? 1 : name === 'logs' ? 2 : 3;
        document.querySelectorAll('.nav-btn')[idx].classList.add('active');
        document.querySelectorAll('.b-nav-item')[idx].classList.add('active');
        
        if(name === 'charts') loadHistory();
        if(name === 'logs') fetchLogs(); // Logs initial laden
    }

    function connectWS() {
        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${protocol}://${window.location.host}`);
        ws.onopen = () => { document.getElementById('connDot').classList.add('connected'); document.getElementById('connDotMobile').classList.add('connected'); };
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            if (msg.type === 'state') updateDashboard(msg.data);
            if (msg.type === 'log') addLog(msg.data); // Live Logs
            if (msg.type === 'mqtt_status') updateMqttStatus(msg.data.connected);
        };
        ws.onclose = () => { document.getElementById('connDot').classList.remove('connected'); document.getElementById('connDotMobile').classList.remove('connected'); setTimeout(connectWS, 3000); };
    }
    connectWS();

    function updateMqttStatus(connected) {
        const dots = document.querySelectorAll('.mqtt-dot');
        dots.forEach(d => connected ? d.classList.add('ok') : d.classList.remove('ok'));
    }

    function updateDashboard(data) {
        currentState = data;
        setText('val-vlt', Math.round(data.VLT));
        setText('val-indoor', data.IndoorTemp);
        setText('val-outdoor', data.OutdoorTemp);
        setText('val-tank', Math.round(data.TankTemp));
        setText('val-ww-target', data.TargetTemp_WW || data.TargetTemp_WW_Alt || "--");
        let vltTarget = "--";
        if(data.Mode === 'heating') vltTarget = data.TargetVLT_Heat;
        else if(data.Mode === 'cooling') vltTarget = data.TargetVLT_Cool;
        setText('val-vlt-target', vltTarget);
        
        const tileVlt = document.getElementById('tile-vlt');
        tileVlt.className = 'tile';
        if(data.Power_Heating === 'on') {
            if(data.Mode === 'heating') tileVlt.classList.add('active-heat');
            else if(data.Mode === 'cooling') tileVlt.classList.add('active-cool');
        }
        const tileTank = document.getElementById('tile-tank');
        tileTank.className = 'tile';
        if(data.Power_WW === 'on') tileTank.classList.add('active-heat');

        let offsetVal = data.Offset_Heat || 0;
        if(data.Mode === 'cooling') offsetVal = data.Offset_Cool || 0;
        setText('val-offset', offsetVal);

        setBtnState('btn-heat-off', data.Power_Heating !== 'on', 'active-on');
        setBtnState('btn-mode-heat', data.Mode === 'heating' && data.Power_Heating === 'on', 'active-heat');
        setBtnState('btn-mode-cool', data.Mode === 'cooling' && data.Power_Heating === 'on', 'active-cool');
        setBtnState('btn-mode-auto', data.Mode === 'auto' && data.Power_Heating === 'on', 'active-on');

        const badge = document.getElementById('badge-mode');
        if (data.Power_Heating !== 'on') { badge.innerText = "STANDBY"; }
        else { badge.innerText = (data.Mode || "UNKNOWN").toUpperCase(); }

        setBtnState('btn-ww-on', data.Power_WW === 'on', 'active-on');
        setBtnState('btn-ww-off', data.Power_WW !== 'on', 'active-on');
        setBtnState('btn-turbo', parseInt(data.Powerful_WW || 0) === 1, 'active-turbo');

        const err = parseInt(data.Error || 0);
        document.getElementById('errorBanner').style.display = err !== 0 ? 'block' : 'none';
        if(err !== 0) document.getElementById('errorBanner').innerText = "⚠️ STÖRUNG: CODE " + err;
    }

    function setText(id, val) { const el = document.getElementById(id); if(el) el.innerText = val !== undefined ? val : '--'; }
    function setBtnState(id, isActive, activeClass) { const el = document.getElementById(id); if(isActive) el.classList.add(activeClass); else el.classList.remove(activeClass); }
    
    // --- UPDATED LOGIC FOR LOGGING ---
    async function fetchLogs() {
        const date = document.getElementById('logDate').value;
        const res = await fetch(`/api/logs?date=${date}`);
        const logs = await res.json();
        
        logContainer.innerHTML = ''; // Clear existing
        logs.forEach(l => {
            // Backend sends raw timestamp, we format here
            addLog({ timestamp: l.timestamp, msg: l.message, type: l.level }, false);
        });
    }

    function addLog(log, isLive = true) {
        // Wenn Live-Log reinkommt, aber wir einen anderen Tag anschauen -> ignorieren
        const selectedDate = document.getElementById('logDate').value;
        const today = new Date().toISOString().split('T')[0];
        if (isLive && selectedDate !== today) return;

        const div = document.createElement('div');
        const catClass = `log-cat-${log.type}`;
        div.className = `log-entry ${catClass}`;
        div.setAttribute('data-type', log.type);
        
        if (currentFilter !== 'all' && currentFilter !== log.type) div.style.display = 'none';

        // Formatierung DE-AT
        const timeStr = new Date(log.timestamp).toLocaleTimeString('de-AT');
        div.innerHTML = `<span class="log-time">${timeStr}</span><span class="log-msg">${log.msg}</span>`;
        
        if (isLive) {
            logContainer.prepend(div);
            if (logContainer.childElementCount > 100) logContainer.lastChild.remove();
        } else {
            logContainer.appendChild(div); // Bei Historie (fetch) hängen wir unten an
        }
    }

    function filterLogs(type, btn) {
        currentFilter = type;
        document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const entries = logContainer.children;
        for (let i = 0; i < entries.length; i++) {
            const entryType = entries[i].getAttribute('data-type');
            if (type === 'all' || entryType === type) entries[i].style.display = 'flex';
            else entries[i].style.display = 'none';
        }
    }

    async function sendCmd(cmd, val) {
        if(cmd === 'offset_heat') {
            let current = parseFloat(currentState.Offset_Heat || 0);
            if(currentState.Mode === 'cooling') current = parseFloat(currentState.Offset_Cool || 0);
            val = current + val;
        }
        await fetch(`/set?cmd=${cmd}&val=${val}`);
    }
    
    async function setMode(mode) {
        try {
            await fetch(`/set?cmd=mode&val=${mode}`);
            await fetch(`/set?cmd=power&val=on`);
        } catch(e) { console.error(e); }
    }
    
    function changeOffset(delta) { sendCmd('offset_heat', delta); }
    function toggleTurbo() { const isTurbo = parseInt(currentState.Powerful_WW || 0); sendCmd('ww_powerful', isTurbo === 1 ? 0 : 1); }
    async function manualRefresh() {
        const icons = document.querySelectorAll('.refresh-icon');
        icons.forEach(i => i.classList.add('spin'));
        try { await fetch('/refresh', { method: 'POST' }); setTimeout(() => icons.forEach(i => i.classList.remove('spin')), 1000); } catch (e) { icons.forEach(i => i.classList.remove('spin')); }
    }

    async function loadHistory() {
        const mode = document.getElementById('chartFilter').value;
        const res = await fetch(`/api/history?mode=${mode}`);
        const data = await res.json();
        if (data.current && data.previous) renderComparison(data.current, data.previous, mode);
        else renderStandard(data);
    }

    function renderStandard(data) {
        const labels = data.map(d => new Date(d.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
        updateChart('vltChart', chartVLT, labels, [
            { label: 'Vorlauf Ist', data: data.map(d => d.vlt), borderColor: '#ffb74d', tension: 0.4 },
            { label: 'Soll', data: data.map(d => d.target), borderColor: '#ffcc80', borderDash: [5,5], tension: 0 }
        ], (c) => chartVLT = c);
        updateChart('tankChart', chartTank, labels, [{ label: 'Warmwasser', data: data.map(d => d.tank), borderColor: '#6dd58c', tension: 0.4 }], (c) => chartTank = c);
        updateChart('indoorChart', chartIndoor, labels, [{ label: 'Innen', data: data.map(d => d.indoor), borderColor: '#a8c7fa', tension: 0.4 }], (c) => chartIndoor = c);
        updateChart('outdoorChart', chartOutdoor, labels, [{ label: 'Außen', data: data.map(d => d.outdoor), borderColor: '#78d9f5', tension: 0.4 }], (c) => chartOutdoor = c);
    }

    function renderComparison(current, previous, mode) {
        const labels = current.map(d => new Date(d.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
        const prevLabel = mode.includes('day') ? 'Gestern' : 'Letzter Monat';
        const currLabel = mode.includes('day') ? 'Heute' : 'Dieser Monat';
        updateChart('vltChart', chartVLT, labels, [
            { label: currLabel, data: current.map(d => d.vlt), borderColor: '#ffb74d', tension: 0.4 },
            { label: prevLabel, data: previous.map(d => d.vlt), borderColor: '#666', borderDash: [5,5], tension: 0.4 }
        ], (c) => chartVLT = c);
        updateChart('tankChart', chartTank, labels, [
            { label: currLabel, data: current.map(d => d.tank), borderColor: '#6dd58c', tension: 0.4 },
            { label: prevLabel, data: previous.map(d => d.tank), borderColor: '#666', borderDash: [5,5], tension: 0.4 }
        ], (c) => chartTank = c);
        updateChart('indoorChart', chartIndoor, labels, [
            { label: currLabel, data: current.map(d => d.indoor), borderColor: '#a8c7fa', tension: 0.4 },
            { label: prevLabel, data: previous.map(d => d.indoor), borderColor: '#666', borderDash: [5,5], tension: 0.4 }
        ], (c) => chartIndoor = c);
        updateChart('outdoorChart', chartOutdoor, labels, [
            { label: currLabel, data: current.map(d => d.outdoor), borderColor: '#78d9f5', tension: 0.4 },
            { label: prevLabel, data: previous.map(d => d.outdoor), borderColor: '#666', borderDash: [5,5], tension: 0.4 }
        ], (c) => chartOutdoor = c);
    }

    function updateChart(id, chartInstance, labels, datasets, setInstanceCallback) {
        const ctx = document.getElementById(id).getContext('2d');
        if(chartInstance) chartInstance.destroy();
        const newChart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                interaction: { mode: 'index', intersect: false },
                scales: { x: { ticks: { color: '#8e918f' }, grid: { color: '#2d2f38' } }, y: { ticks: { color: '#8e918f' }, grid: { color: '#2d2f38' } } }, 
                plugins: { legend: { labels: { color: '#e2e2e6' } } },
                elements: { point: { radius: 0, hitRadius: 10 } }
            }
        });
        setInstanceCallback(newChart);
    }

    async function loadConfig() {
        try {
            const res = await fetch('/api/config');
            const cfg = await res.json();
            document.getElementById('cfg-daikin').value = cfg.daikinIp || "";
            document.getElementById('cfg-loxone').value = cfg.loxoneIp || "";
            document.getElementById('cfg-port').value = cfg.loxonePort || 7000;
            document.getElementById('cfg-keepAlive').value = cfg.udpKeepAlive || 90;
            document.getElementById('cfg-mqttBroker').value = cfg.mqttBroker || "";
            document.getElementById('cfg-mqttTopic').value = cfg.mqttTopic || "daikin";
            document.getElementById('cfg-mqttUser').value = cfg.mqttUser || "";
            document.getElementById('cfg-mqttPass').value = cfg.mqttPass || "";
        } catch(e) {}
    }

    async function saveConfig() {
        const newCfg = {
            daikinIp: document.getElementById('cfg-daikin').value,
            loxoneIp: document.getElementById('cfg-loxone').value,
            loxonePort: parseInt(document.getElementById('cfg-port').value),
            udpKeepAlive: parseInt(document.getElementById('cfg-keepAlive').value),
            mqttBroker: document.getElementById('cfg-mqttBroker').value,
            mqttTopic: document.getElementById('cfg-mqttTopic').value,
            mqttUser: document.getElementById('cfg-mqttUser').value,
            mqttPass: document.getElementById('cfg-mqttPass').value
        };
        await fetch('/api/config', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(newCfg) });
        alert("Gespeichert. Server startet neu.");
    }
    loadConfig();
</script>
</body>
</html>